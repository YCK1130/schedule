import{g as e,p as i,i as t,c as n}from"./utils-DJ2i655f.js";function r(e,i){try{const[t,n]=e.split("/"),[r,a]=i.split("/"),s=new Date(t),l=new Date(n),o=new Date(r);return s<new Date(a)&&o<l}catch(t){return!1}}function a(e,i){try{const[t]=e.split("/"),n=new Date(t),r=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0"),l=String(n.getHours()).padStart(2,"0"),o=`${r}-${a}-${s}-${l}-${String(30*Math.round(n.getMinutes()/30)).padStart(2,"0")}`;return i.byDateAndTime.get(o)}catch(t){return null}}function s(s,l,o,c){try{const{interviews:d,unmatched:v}=((s,l,o,c)=>{const d={interviewers:[],interviewees:[],reasons:[]},v=[],h=s.filter(e=>e.availability.length>0),f=l.filter(e=>e.availability.length>0),g=new Map;if(h.forEach(e=>{g.set(e.id,0)}),0===h.length||0===f.length)return s.filter(e=>!e.availability||0===e.availability.length).forEach(e=>{d.interviewers.push(e),d.reasons.push(`面試官 ${e.name} 沒有可用時段`)}),l.filter(e=>!e.availability||0===e.availability.length).forEach(e=>{d.interviewees.push(e),d.reasons.push(`應試者 ${e.name} 沒有可用時段`)}),{interviews:v,unmatched:d};let m=e(s,l);m=c&&c.initialized?m.sort((e,t)=>{const n=a(e,c),r=a(t,c),s=(n?.availableInterviewers.length||0)+(n?.availableInterviewees.length||0),l=(r?.availableInterviewers.length||0)+(r?.availableInterviewees.length||0);if(s!==l)return s-l;const o=i(e).start,d=i(t).start;return o.getTime()-d.getTime()}):m.sort((e,n)=>{const r=h.filter(i=>t(i,e,v)).length+f.filter(i=>t(i,e,v)).length,a=h.filter(e=>t(e,n,v)).length+f.filter(e=>t(e,n,v)).length;if(r!==a)return r-a;const s=i(e).start,l=i(n).start;return s.getTime()-l.getTime()});const u=new Set,w={};f.forEach(e=>{const i=e.position||"未指定";w[i]||(w[i]=[]),w[i].push(e)}),h.forEach(e=>{e.origin_availability&&(e.availability=e.origin_availability)});for(const e in w)for(const i of m){let s=[];if(c&&c.initialized){const t=a(i,c);t&&(s=t.availableInterviewees.filter(i=>(i.position===e||"未指定"===e)&&!u.has(i.id)))}else s=w[e].filter(e=>t(e,i,v)&&!u.has(e.id));if(0===s.length)continue;let l=[];if(c&&c.initialized){const e=a(i,c);e&&(l=e.availableInterviewers.filter(e=>!v.some(t=>r(`${t.startTime}/${t.endTime}`,i)&&t.interviewers.some(i=>i.id===e.id))),l.sort((e,i)=>(g.get(e.id)||0)-(g.get(i.id)||0)))}else l=h.filter(e=>t(e,i,v)),l.sort((e,i)=>(g.get(e.id)||0)-(g.get(i.id)||0));const f=n(o,l,s,v);if(!f.valid){d.reasons.push(f.reason);continue}const[m,p]=i.split("/"),b={interviewers:f.interviewers.map(e=>({id:e.id,name:e.name,position:e.position})),interviewees:f.interviewees.map(e=>({id:e.id,name:e.name,position:e.position})),startTime:m,endTime:p};v.push(b),f.interviewees.forEach(e=>{u.add(e.id)}),f.interviewers.forEach(e=>{const t=g.get(e.id)||0;g.set(e.id,t+1),Array.isArray(e.availability)&&(e.availability=e.availability.filter(e=>!r(e,i)))})}for(const e of v){const i=e.interviewers.map(e=>e.id),n=`${e.startTime}/${e.endTime}`;let s=[];if(c&&c.initialized){const t=a(n,c);t&&(s=t.availableInterviewers.filter(t=>!i.includes(t.id)&&!v.some(i=>i!==e&&(r(`${i.startTime}/${i.endTime}`,n)&&i.interviewers.some(e=>e.id===t.id)))))}else s=h.filter(r=>t(r,n,v.filter(i=>i!==e))&&!i.includes(r.id));const l=Array.from(o.keys()).map(e=>e.split(":")[1]).filter(e=>"所有"!==e),d=s.sort((e,i)=>{const t=g.get(e.id)||0,n=g.get(i.id)||0;return t!==n?t-n:e.availability.length-i.availability.length}),{max:f}=o.get("interviewers:所有")||{max:100},m=d.filter(e=>!l.includes(`${e.position}`)),u=Math.min(m.length+i.length,f)-i.length;if(u>0){const i=d.slice(0,u);e.interviewers.push(...i.map(e=>({id:e.id,name:e.name,position:e.position}))),i.forEach(e=>{const i=g.get(e.id)||0;g.set(e.id,i+1)})}}const p=f.filter(e=>!u.has(e.id));return p.forEach(e=>{d.interviewees.includes(e)||(d.interviewees.push(e),d.reasons.push(`無法為應試者 ${e.name} 找到符合限制條件的時段`))}),{interviews:v.map((e,i)=>({...e,id:i+1})),unmatched:{interviewers:h,interviewees:p,reasons:d.reasons}}})(s,l,o,c);return{interviews:d,unmatched:v}}catch(d){return{interviews:[],unmatched:{interviewers:s,interviewees:l,reasons:["排程過程發生錯誤"]}}}}export{s};
